# T2S Run Experiment Gemini Fine-Tuning

This repository contains Python scripts to run experiments using a **fine-tuned Gemini model**. It automates:
1. Generating SQL queries from natural language questions (NLQs).
2. Executing those queries against a database.
3. Comparing results with expected outputs.
4. Performing various analyses on performance, accuracy, and errors.

## Key Scripts

1. **run_experiment.py**  
   - **Purpose**:  
     - Reads the experiment configuration (database, model name, number of records, etc.).
     - Connects to a database and retrieves table schemas.
     - Generates SQL queries from natural language questions using a fine-tuned Gemini model.
     - Executes both expected SQL queries and inferred SQL queries.
     - Saves the results (including any errors) to an Excel file and a log file.

2. **run_analysis.py**  
   - **Purpose**:  
     - Reads the Excel file produced by run_experiment.py.
     - Classifies errors (syntactic, semantic, unknown, or no error).
     - Checks for matching SQL queries and matching results.
     - Calculates metrics such as match percentages, average inference time, and consistency of generated queries.
     - Outputs the analysis to a new Excel file with multiple sheets (original data, matches, errors, times, consistency, summary).

3. **run_general_analysis.py**  
   - **Purpose**:  
     - Looks for multiple experiment result files in a specified directory (e.g., results/).
     - Consolidates their metrics into a DataFrame.
     - Generates comparison plots (bar charts) for matches, errors, and inference times.
     - Saves the plots as images.

## Requirements and Installation

1. **Clone this repository**:
   ```sh
    git clone https://github.com/cecanong/t2s-run-experiment-gemini-ft.git
    cd t2s-run-experiment-gemini-ft
   ```

2. **Install the required dependencies**:

   ```sh
    pip install -r requirements.txt
   ```
   
   Make sure you have a Python 3.x environment set up.

3. **Credentials for Generative AI**:
   - Place your credential files (client_secret.json, token.json, etc.) as needed for Google Generative AI access.
   - Check and update load_creds.py if you need to change how credentials are loaded.

## Configuration

All experiment settings are stored in config.json. Below is an example structure:

    {
      "output_path": "findings/",
      "output_file_test": "dataset/test_data.xlsx",
      "connection_string": "sqlite:///database/my_db.sqlite",
      "gemini10": "models/fine_tuned_gemini_1.0",
      "gemini20": "models/fine_tuned_gemini_2.0"
    }

- **output_path**: Directory for saving logs, results, or findings.
- **output_file_test**: Path to the Excel file containing test NLQs and expected SQL queries.
- **connection_string**: Database connection string (in this case, SQLite).
- **gemini10, gemini20, etc.**: Model names or paths for different Gemini model versions.

## Usage

### 1. Run an Experiment

    python run_experiment.py

- **What it does**:
  - Reads configuration from config.json.
  - Loads the corresponding Gemini model credentials (load_creds.py).
  - Fetches table schemas from your database (defined in connection_string).
  - Reads NLQs and expected SQL queries from the specified Excel file (output_file_test).
  - Uses the fine-tuned Gemini model to generate SQL queries for each NLQ.
  - Executes queries and saves results to findings/<experiment_name>_res.xlsx and logs to findings/<experiment_name>_log.txt.

### 2. Analyze Results

    python run_analysis.py

- **What it does**:
  - Reads the Excel file generated by run_experiment.py.
  - Classifies errors, computes match percentages for SQL and query results, and calculates inference times.
  - Generates a detailed analysis file in results/<experiment_name>_analysis.xlsx.

### 3. General Comparison Across Experiments

    python run_general_analysis.py

- **What it does**:
  - Searches the results/ directory for files matching specific experiment or model names.
  - Consolidates their metrics into a DataFrame.
  - Generates bar charts comparing matches, errors, and inference times.
  - Saves the charts in the images/ directory (configurable in the script).

## Customization

- **experiments.py**: Define your experiments, each with a unique id_experiment and relevant fields (model name, prompt template, etc.).
- **prompts_to_use.py**: Store and manage the prompt templates used by run_experiment.py.
- **load_creds.py**: Adjust if you have a different mechanism for loading credentials for the Gemini model.

## Troubleshooting

- **Database Connection Errors**:  
  - Check the connection_string in config.json.
  - Ensure your SQLite database file exists or your other DB credentials are correct.
- **Credentials**:  
  - Make sure you have the correct credentials for the Google Generative AI API or any other required services.
- **Dependencies**:  
  - If you run into missing libraries, verify your requirements.txt installation.

## License

This project is released under the [MIT License](LICENSE) (or add your chosen license here). Feel free to use and adapt the code according to its terms.

---
